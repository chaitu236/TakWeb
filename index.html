<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta charset="utf-8">
        <meta name="description" content="Play online Tak games. Tak is a strategy board game created by James Ernest and Patrick Rothfuss">
        <meta name="keywords" content="online tak, playtak, play tak">

        <title>Tak</title>

        <script>
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r;
                i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date();
                a = s.createElement(o),
                        m = s.getElementsByTagName(o)[0];
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m)
            })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-68947366-1', 'auto');
            ga('send', 'pageview');

        </script>

        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/bootstrap-tour.min.css">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="js/three.min.js"></script>
        <script src="js/OrbitControls.min.js"></script>
        <script src="js/helvetiker_regular.typeface.js"></script>

<!--        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>-->
        <script src="js/bootstrap.min.js"></script>
        <script src="js/bootstrap-tour.min.js"></script>
        <script src="js/playtaktour.js"></script>

        <style>
            body {
                margin: 0px;
                padding: 0px;
                overflow: hidden;
            }
            #gamecanvas{
                display: block;
                position: absolute;
                left: 0px;
                top: 0px;
            }
            #floating {
                position: absolute;
                left: 5px;
                top: 20%;
                z-index: 10;
            }
            #chat-toggle-button{
                position: absolute;
                right: 185px;
                top: 62px;
                z-index: 10;
            }
            #chat {
                position: absolute;
                right: 5px;
                top: 60px;
                z-index: 10;
                width: 180px;
                height: 80%;
            }
            #chat-server {
                height:100%;
            }
            .toggle-text {
                border-radius: 2px;
                border: 2px solid #404040;
                border-radius: 5px;
                text-align: center;
                color: #c3c3c3;
                background-color: #404040;
                line-height: 12px;
                width: 19px;
            }
            #help-modal ul li ul {
              font-weight: bold;
            }
            #help-modal ul li ul li {
              font-weight: normal;
            }
            #chat-toggle-text {
            }
            #notation-toggle-text {
                position: absolute;
                right: -17px;
                top: 2px;
            }
            .width-full {
                margin: 0 auto;
                width: 100%;
            }
            .height-full {
                margin: 0 auto;
                height: 100%;
            }
            #status {
                position: absolute;
                bottom: 0px;
                right: 0px;
                z-index: 10;
            }
            #pindicator {
                position: absolute;
                top: 60px;
                left: 50%;
                transform: translate(-50%, 0);
                font-size: 200%;
                z-index: 10;
            }
            #zoomcontrols {
                position: absolute;
                bottom: 5px;
                left: 5px;
                z-index: 10;
            }
            #rmenu {
                border-style: solid;
                border-width: 2px;
                border-color: black;
                padding: 5px;
                margin: 2px;
                width: 200px;
                text-align: left;
                overflow: hidden;
                background-color: #e7e7e7;
            }
            #notationbar {
                height: 150px;
                overflow: auto;
            }
            #alertbox {
                position: absolute;
                bottom: 0px;
                width: 100%;
                z-index: 8;
            }
            .alerts {
                width: 60%;
                margin: auto;
            }
            .alert {
                margin: 0px;
            }
            #moveslist {
                display: table;
                width: 150px;
            }
            .center {
                text-align: center;
            }
            .left {
                text-align: left;
            }
            .right {
                text-align: right;
            }
            .vertical-text {
                transform-origin: bottom right;
                transform: rotate(-90deg);
                float: left;
            }
            .modal {
              text-align: center;
            }
            .modal:before {
              display: inline-block;
              vertical-align: middle;
              content: " ";
              height: 100%;
            }
            .modal-dialog {
              display: inline-block;
              text-align: left;
              vertical-align: middle;
            }
/*            #moveslist thead, #moveslist tbody{
                float: left;
                width: 100%;
            }
            #moveslist tbody {
                overflow: auto;
                height: 150px;
            }
            #moveslist tr {
                width: 100%;
                display: table;
                text-align: left;
            }
            #moveslist>tr>td {
                text-align: left;
            }
            #moveslist>tr>td:last-child {
                text-align: right;
            }*/
            .selected {
                background: red;
            }
            .unselected {
                background: grey;
            }
            .selectplayer {
                border-radius: 20px;
                border: 2px solid black;
            }
            #player-opp, .player1-name {
                display: inline;
                /*color: #d8cdab;*/
                color: #a3a3a3;
                padding: 2px;
            }
            #player-me, .player2-name {
                display: inline;
                /*color: #593514;*/
                color: black;
                padding: 2px;
            }
            .border {
              border-radius : 20px;
              padding: 5px;
              margin: 2px;
              border : 2px solid black;
            }
        </style>

    </head>
    <div class="device-xs hidden-xs"></div>
    <div class="device-sm hidden-sm"></div>
    <div class="device-md hidden-md"></div>
    <div class="device-lg hidden-lg"></div>

    <body style="border:1px solid #000000;">

        <!-- Static navbar -->
        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div id="navbar" class="navbar-collapse collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="#" data-toggle="modal" data-target="#help-modal">Help</a></li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" role="button" data-toggle="dropdown"
                               title="Create a new empty board to play locally" aria-haspopup="true" aria-expanded="false"
                               id="scratchsize"> Scratch Board
                                <span class="caret"></span></a>

                            <ul class="dropdown-menu">
                                <li><a href="#" onclick="scratchbutton(3);">3x3</a></li>
                                <li><a href="#" onclick="scratchbutton(4);">4x4</a></li>
                                <li><a href="#" onclick="scratchbutton(5);">5x5</a></li>
                                <li><a href="#" onclick="scratchbutton(6);">6x6</a></li>
                                <li><a href="#" onclick="scratchbutton(7);">7x7</a></li>
                                <li><a href="#" onclick="scratchbutton(8);">8x8</a></li>
                            </ul>
                        </li>
                        <!--<li><a  class="visible-xs-block" title="Reverse view" class="hidden-xs" href="#" onclick="board.reverseboard()">Flip view</a></li>-->
                        <li><a id="loadtps" href="#" onclick="loadtpn()">Load TPS</a></li>
                        <li>
                          <a id="creategame" href="#" title="Create online game" onclick="$('#creategamemodal').modal('show')">New Game</a>
                        </li>
                        <li class="dropdown">
                            <a id="joingame" href="#" class="dropdown-toggle" role="button" data-toggle="dropdown"
                               title="Accept a seek" aria-haspopup="true" aria-expanded="false"> Join game
                                <span class="badge" id="seekcount">0</span>
                                <span class="caret"></span></a>
                            <ul id="seeklist" class="dropdown-menu">
                            </ul>
                        </li>
                        <li class="dropdown">
                            <a id="watch" href="#" class="dropdown-toggle" role="button" data-toggle="dropdown"
                               title="Observe a game" aria-haspopup="true" aria-expanded="false"> Watch
                                <span class="badge" id="gamecount">0</span>
                                <span class="caret"></span></a>
                            <ul id="gamelist" class="dropdown-menu">
                            </ul>
                        </li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" title="Mute/Un mute" role="button" onclick="volume_change()">
                            <!--<button type="button" class="btn btn-default">-->
                                <img id="volume-img" src="images/ic_volume_up_black_24px.svg" height="20" width="20"/>
                            <!--</button>-->
                            </a>
                            <audio id="move-sound">
                                <source src="audio/move.mp3" type="audio/mpeg">
                            </audio>
                            <audio id="chime-sound">
                                <source src="audio/chime.mp3" type="audio/mpeg">
                            </audio>
                        </li>
                        <li>
                            <a href="#" title="Number of online players" >Online <span class="badge" id="onlineplayers">0</span></a>
                        </li>
                        <li>
                            <button id="login-button" type="button" class="btn btn-default navbar-btn" onclick="server.init()">Sign up / Login</button>
                        </li>
                    </ul>
                </div><!--/.nav-collapse -->
            </div>
        </nav>

        <div id="floating">
            <a title="Click to show/hide menu" href="#" onclick="rmenu()">
                <!--<img src="images/ic_menu_black_24px.svg" height="30" width="30"/>-->
                <div id="notation-toggle-text" class="toggle-text">
                    <<<br>n<br>o<br>t<br>a<br>t<br>i<br>o<br>n
                </div>
            </a>
            <ul id="rmenu" style="list-style-type:none">
                <li class="center">
                    <div id="player-opp">
                    <img id="player-opp-img" src="images/player-white.png" height="20" width="20">
                    <div id="player-opp-name" class="player1-name">You</div>
                    </div>
                    <div id="player-opp-time" class="player1-time">0:00</div>
                </li>
                <li class="center">
                    <!--<a href="#" title="Reverse board" onclick="board.reverseboard()"><img src="images/ic_screen_rotation_black_24px.svg" width="25 height=25"></a>-->
                    <a href="#" title="Offer/Accept draw" class="btn" onclick="server.draw()"><img id="draw" src="images/offer-hand.png" width="25" height="25"></a>
                    <a href="#" title="Resign" class="btn" onclick="server.resign()"><img src="images/flag.svg" width="25" height="20"></a>
                </li>
                <li>
                    <div title="Notation for current game appears here" id="notationbar">
                        <!--<div class="center">Game notation</div>-->
                        <table id="moveslist">
                        </table>
                    </div>
                </li>
                <li class="center">
                    <div id="player-me">
                    <img id="player-me-img" src="images/player-black.png" height="20" width="20">
                    <div id="player-me-name" class="player2-name">You</div>
                    </div>
                    <div id="player-me-time" class="player2-time">0:00</div>
                </li>
            </ul>
        </div>

        <div id="chat-toggle-button">
            <a href="#" onclick="togglechat()">
                <!--<img src="images/ic_menu_black_24px.svg" width="24" height="24">-->
                <!--<div class="vertical-text">chat</div>-->
                <div id="chat-toggle-text" class="toggle-text">
                >><br>
                c<br>h<br>a<br>t
                </div>
            </a>
        </div>
        <div id="chat"">
                <div class="form-group height-full">
                    <textarea class="form-control" id="chat-server" readonly></textarea>
                </div>
            <form role="form" onsubmit="server.chat(); return false;" class="height-full" autocomplete="off">
                    <input type="text" class="form-control" id="chat-me"></textarea>
                <button type="submit" class="btn btn-primary">Send</button>
            </form>
        </div>

        <div>
            <canvas id="gamecanvas" style="border:1px solid #000000;"></canvas>
        </div>

<!--        <div id="status">
            <input id="status-inp" type="text">
            <button onclick="statusclick()">Ok</button>
        </div>-->

        <div id="alertbox">
            <div class="alerts">
                <div id="alert" class="alert alert-dismissible hidden" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <span id="alert-text">Text</span>
                </div>
            </div>
        </div>

        <div id="creategamemodal" class="modal fade" role="dialog">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="row">
                          <div class="col-sm-12">
                            <div class="form-group">
                              <label for="boardsize"> Board Size</label>
                              <select class="form-control" id="boardsize">
                                <option>3x3</option>
                                <option>4x4</option>
                                <option selected="selected">5x5</option>
                                <option>6x6</option>
                                <option>7x7</option>
                                <option>8x8</option>
                              </select>
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-sm-12">
                            <div class="form-group">
                              <label for="time">Time (minutes per player)</label>
                              <select class="form-control" id="timeselect">
                                <option>1</option>
                                <option>3</option>
                                <option>5</option>
                                <option selected="selected">10</option>
                                <option>15</option>
                                <option>20</option>
                                <option>30</option>
                                <option>60</option>
                                <option>180</option>
                              </select>
                            </div>
                          </div>
                        </div>
                        <div class="row center">
                          <div class="col-sm-12">
                            <form role="form" onsubmit="server.seek(); return false;">
                              <button type="submit" class="btn btn-primary">Create</button>
                            </form>
                          </div>
                        </div>
                        <div class="row center">
                          <div class="col-sm-12">
                            <form role="form" onsubmit="server.removeseek(); return false;">
                              <br>
                              <button type="submit" class="btn btn-default">Remove Seeks</button>
                            </form>
                          </div>
                        </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="gameoveralert" class="modal fade" role="dialog">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-sm-6 center" id="gameoveralert-text">
                            </div>
                        </div>
                        <div class="modal-footer center">
                          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
           </div>
        </div>

        <div id="login" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="row border">
                            <div class="col-sm-6">
                                <form role="form" onsubmit="server.login(); return false;">
                                    <div class="form-group">
                                        <label for="usr">Username</label>
                                        <input type="text" class="form-control" id="login-username">
                                    </div>
                                    <div class="form-group">
                                        <label for="pwd">Password:</label>
                                        <input type="password" class="form-control" id="login-pwd">
                                    </div>
                                    <div class="checkbox">
                                      <label><input id = "keeploggedin" type="checkbox" value="">Keep me logged in</label>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Login</button>
                                </form>
                            </div>
                            <div class="col-sm-6">
                                <form role="form" onsubmit="server.register(); return false;">
                                    <div class="form-group">
                                        <label for="usr">Username</label>
                                        <input type="text" class="form-control" id="register-username">
                                    </div>
                                    <div class="form-group">
                                        <label for="email">Email address:</label>
                                        <input type="email" class="form-control" id="register-email">
                                    </div>
                                    <div class="checkbox" style="visibility:hidden">
                                      <label><input type="checkbox" value="">Keep me logged in</label>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Sign up</button>
                                </form>
                            </div>
                        </div>
                        <div class="row center">
                            <br>Or<br><br>
                          <div class="col-sm-12">
                            <form role="form" onsubmit="server.guestlogin(); return false;">
                              <button type="submit" class="btn btn-default">Guest Login</button>
                            </form>
                          </div>
                        </div>
                        <div class="row center">
                          <div class="col-sm-12">
                            <div id="alert2" class="alert alert-dismissible hidden" role="alert">
                                <span id="alert-text2">Text</span>
                            </div>
                          </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal" onclick="server.init()">Close</button>
                    </div>
                </div>

            </div>
        </div>
        <div id="help-modal" class="modal fade">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Help</h4>
                    </div>
                    <div class="modal-body">
                        <ul>
                            <li><ul> Rules - the short version:
                                    <li>White goes first</li>
                                    <li>On first move, each player must place his opponent's tile</li>
                                    <li>Create a path with flat stones and capstones between any two opposite ends of the board</li>
                                    <li>Complete rules can be found <a target="_blank" href="http://cheapass.com/sites/default/files/TakBetaRules3-10-16.pdf">here</a> [PDF].</li>
                                </ul></li>
                            <li><ul>Controls:
                                    <li>Left click-drag (or touch-drag) to rotate board</li>
                                    <li>Left click a piece to select it. Left click on it again (or right click) to rotate it</li>
                                    <li>Left click on a square to place selected piece or to pick up stack</li>
                                    <li>Right click on a stack to hide pieces on all other squares (to see stack clearly)</li>
                                    <li>Right click-drag to move the board. For touch devices, three-finger touch and drag</li>
                                    <li>Scroll wheel to zoom in/out. For touch devices, use two-finger pinch. Or use zoom buttons on bottom right.</li>
                                    <li>Current player to move is indicated by highlighting their name with a border</li>
                                    <li>If any of the above controls don't work, it means that control is invalid for current move</li>
                                </ul></li>
                            <li><ul>Play locally:
                                    <li>Select board size to create a new empty board on which you can play locally</li>
                                </ul></li>
                            <li><ul>Play online:
                                    <li>Login to server by clicking "Sign up/Login" button, signup and then login</li>
                                    <li>Post your seek by selecting board size in "Create game" menu or accept another player's
                                        seek by selecting it in "Join game" menu</li>
                                    <li>Click on one of any ongoing games from "Watch" menu to watch an ongoing game</li>
                                </ul></li>
                            <li><ul>About the game:
                                    <li>Rules for TAK are made by <a target="_blank" href="https://en.wikipedia.org/wiki/James_Ernest">James Ernest</a> and <a target="_blank" href="https://en.wikipedia.org/wiki/Patrick_Rothfuss">Patrick Rothfuss</a>. Visit <a target="_blank" href="http://cheapass.com/games/tak">cheapass.com</a> for more info</li>
                                    <li>This is an unofficial implementation by <a target="_blank" href="https://github.com/chaitu236">Chaitanya Vadrevu (me)</a></li>
                                    <li>Front end code can be found <a target="_blank" href="https://github.com/chaitu236/TakWeb">here</a>,
                                    backend code <a target="_blank" href="https://github.com/chaitu236/TakServer">here</a></li>
                                    <li>Check out <a target="_blank" href="https://www.reddit.com/r/KingkillerChronicle/">these </a>
                                        - <a target="_blank" href="https://www.reddit.com/r/Tak/"> awesome</a> subreddits</li>
                                </ul></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="zoomcontrols">
            <a href="#" onclick="zoom(true)">
                <img src="images/ic_zoom_out_black_24px.svg" height="40" width="40"/>
            </a>
            <a href="#" onclick="zoom(false)">
                <img src="images/ic_zoom_in_black_24px.svg" height="40" width="40"/>
            </a>
            <a href="#" onclick="board.reverseboard()">
                <img src="images/ic_screen_rotation_black_24px.svg" height="35" width="35"/>
            </a>
            <a href="#" onclick="tour(true)">
                <img title="Take tour" src="images/bus.png" height="35" width="35"/>
            </a>
        </div>

        <script>

            function alert(type, msg) {
                $('#alert-text').text(msg);
                var $alert = $('#alert');
                $alert.removeClass("alert-success alert-info alert-warning alert-danger");

                $alert.addClass("alert-"+type);
                $alert.removeClass('hidden');
                $alert.stop(true, true);
                $alert.fadeTo(4000, 500).slideUp(500, function() {
                    $alert.addClass('hidden');
                });
                alert2(type, msg);
            }
            function alert2(type, msg) {
                $('#alert-text2').text(msg);
                var $alert = $('#alert2');
                $alert.removeClass("alert-success alert-info alert-warning alert-danger");

                $alert.addClass("alert-"+type);
                $alert.removeClass('hidden');
                $alert.stop(true, true);
                $alert.fadeTo(4000, 500).slideUp(500, function() {
                    $alert.addClass('hidden');
                });
            }
            var camera, scene, renderer, light, canvas, controls = null;

            var piece_size = 88;
            var piece_height = 15;
            var sq_size = 90;
            var sq_height = 15;
            var capstone_height = 70;
            var capstone_radius = 30;
            var stack_selection_height = 60;
            var border_size = 30;
            var letter_size = 12;

            var raycaster = new THREE.Raycaster();
            var highlighter;
            var mouse = new THREE.Vector2();
            var offset = new THREE.Vector3();

            var board = {
                size: 0,
                totcaps: 0,
                tottiles: 0,
                whitepiecesleft: 0,
                blackpiecesleft: 0,
                mycolor: "white",
                movecount: 0,
                scratch: true,
                sq: [],
                board_objects: [],
                piece_objects: [],
                move: {start: null, end: null, dir: 'U', squares: []},
                highlighted: null,
                totalhighlighted: null,
                selected: null,
                selectedStack: null,
                ismymove: false,
                server: null,
                gameno: 0,
                boardside: "white",
                result: "none",
                observing: false,
                position: {x: 0, y: 0, endx: 0, endz: 0},
                init: function (sz, col, scr, obs) {
                    this.size = sz;

                    if (sz === 3) {
                        this.totcaps = 0;
                        this.tottiles = 10;
                    } else if (sz === 4) {
                        this.totcaps = 0;
                        this.tottiles = 15;
                    } else if (sz === 5) {
                        this.totcaps = 1;
                        this.tottiles = 21;
                    } else if (sz === 6) {
                        this.totcaps = 1;
                        this.tottiles = 30;
                    } else if (sz === 7) {
                        this.totcaps = 2;
                        this.tottiles = 40;
                    } else {
                        this.totcaps = 2;
                        this.tottiles = 50;
                    }
                    this.whitepiecesleft = this.tottiles + this.totcaps;
                    this.blackpiecesleft = this.tottiles + this.totcaps;

                    this.mycolor = col;
                    this.sq = [];
                    this.movecount = 0;
                    this.scratch = scr;
                    this.board_objects = [];
                    this.piece_objects = [];
                    this.highlighted = null;
                    this.selected = null;
                    this.selectedStack = null;
                    this.gameno = 0;
                    this.move = {start: null, end: null, dir: 'U', squares: []};
                    this.result = "none";
                    this.observing = typeof obs !== 'undefined' ? obs : false;
                    this.ismymove = this.checkifmymove();

                    for (i = 0; i < this.size; i++) {
                        this.sq[i] = [];
                        for (j = 0; j < this.size; j++) {
                            this.sq[i][j] = [];
                        }
                    }

                    this.addboard();
                    this.addpieces();

                    var material = new THREE.LineBasicMaterial({color: 0x0000f0});
                    var pyramid = new THREE.CylinderGeometry(0, 50, 50, 3, false);

                    document.getElementById("player-opp").className = "selectplayer";
                    document.getElementById("player-me").className = "";

                    if (this.mycolor !== this.boardside)
                        this.reverseboard();
                },
                addboard: function () {
                    var white_texture = THREE.ImageUtils.loadTexture('images/whitesquare.png');
                    var black_texture = THREE.ImageUtils.loadTexture('images/blacksquare.png');

                    var geometry = new THREE.BoxGeometry(sq_size, sq_height, sq_size);
                    geometry.center();

                    var white_material = new THREE.MeshBasicMaterial({map: white_texture});
                    var black_material = new THREE.MeshBasicMaterial({map: black_texture});

                    var startx = -(this.size * sq_size) / 2.0 + sq_size / 2;
                    var startz = -(this.size * sq_size) / 2.0;

                    this.position.x = startx;
                    this.position.z = startz;
                    this.position.endx = startx + this.size * sq_size;
                    this.position.endz = startz + this.size * sq_size;

                    for (i = 0; i < this.size; i++) {
                        for (j = 0; j < this.size; j++) {
                            piece = new THREE.Mesh(geometry, ((i + j) % 2) ? white_material : black_material);
                            piece.position.set(startx + i * sq_size, 0, startz + j * sq_size);

                            piece.file = i;//String.fromCharCode('A'.charCodeAt(0)+i);
                            piece.rank = this.size - 1 - j;
                            piece.isboard = true;

                            this.board_objects.push(piece);
                            this.sq[i][j].board_object = piece;
                            scene.add(piece);
                        }
                    }

                    var border_material = new THREE.MeshBasicMaterial({color: 0x6f4734});
                    geometry = new THREE.BoxGeometry(this.size * sq_size + 2 * border_size, piece_height, border_size);

                    var border = new THREE.Mesh(geometry, border_material);
                    border.position.set(0, 0, startz - sq_size / 2 - border_size / 2);
                    scene.add(border);

                    border = new THREE.Mesh(geometry, border_material);
                    border.rotateY(Math.PI);
                    border.position.set(0, 0, this.position.endz - sq_size / 2 + border_size / 2);
                    scene.add(border);

                    geometry = new THREE.BoxGeometry(this.size * sq_size, piece_height, border_size);
                    border = new THREE.Mesh(geometry, border_material);
                    border.rotateY(Math.PI / 2);
                    border.position.set(this.position.x - sq_size / 2 - border_size / 2, 0, -sq_size / 2);
                    scene.add(border);

                    border = new THREE.Mesh(geometry, border_material);
                    border.rotateY(-Math.PI / 2);
                    border.position.set(this.position.endx - border_size, 0, -sq_size / 2);
                    scene.add(border);

                    var material = new THREE.MeshBasicMaterial({color: 0xFFF5B5});
                    for (var i = 0; i < this.size; i++) {
                        geometry = new THREE.TextGeometry(String.fromCharCode('A'.charCodeAt(0) + i),
                                {size: letter_size, height: 1, font: 'helvetiker', weight: 'normal'});

                        var letter = new THREE.Mesh(geometry, material);
                        letter.rotateX(-Math.PI / 2);
                        letter.position.set(this.position.x - letter_size / 2 + i * sq_size, sq_height / 2,
                                this.position.endz - border_size / 2 - letter_size);
                        scene.add(letter);

                        geometry = new THREE.TextGeometry(String.fromCharCode('1'.charCodeAt(0) + i),
                                {size: letter_size, height: 1, font: 'helvetiker', weight: 'normal'});
                        letter = new THREE.Mesh(geometry, material);
                        letter.rotateX(-Math.PI / 2);
                        letter.position.set(this.position.x - sq_size / 2 - border_size / 2 - letter_size / 2, sq_height / 2,
                                this.position.endz - border_size - sq_size / 2 - i * sq_size);
                        scene.add(letter);
                    }
                    for (var i = this.size - 1; i >= 0; i--) {
                        geometry = new THREE.TextGeometry(String.fromCharCode('A'.charCodeAt(0) + i),
                                {size: letter_size, height: 1, font: 'helvetiker', weight: 'normal'});
                        var letter = new THREE.Mesh(geometry, material);
                        letter.rotateX(Math.PI / 2);
                        letter.rotateY(Math.PI);
                        letter.position.set(this.position.x - letter_size / 2 + i * sq_size, sq_height / 2,
                                this.position.z - sq_size / 2 - border_size / 2 - letter_size / 2);
                        scene.add(letter);

                        geometry = new THREE.TextGeometry(String.fromCharCode('1'.charCodeAt(0) + i),
                                {size: letter_size, height: 1, font: 'helvetiker', weight: 'normal'});
                        letter = new THREE.Mesh(geometry, material);
                        letter.rotateX(-Math.PI / 2);
                        letter.rotateZ(Math.PI);
                        letter.position.set(this.position.endx - sq_size / 2 + border_size / 2 + letter_size / 2, sq_height / 2,
                                this.position.endz - border_size - sq_size / 2 - letter_size - i * sq_size);
                        scene.add(letter);
                    }
                    this.position.x -= border_size;
                    this.position.z -= border_size;
                    this.position.endx += border_size;
                    this.position.endz += border_size;

                },
                addpieces: function () {
                    var white_texture = THREE.ImageUtils.loadTexture('images/whitetile2.png');
                    var black_texture = THREE.ImageUtils.loadTexture('images/blacktile2.png');
                    var white_cap_texture = THREE.ImageUtils.loadTexture('images/white_capstone.png');
                    var black_cap_texture = THREE.ImageUtils.loadTexture('images/black_capstone.png');

                    var geometry = new THREE.BoxGeometry(piece_size, piece_height, piece_size);
                    geometry.center();

                    var white_material = new THREE.MeshBasicMaterial({map: white_texture});
                    var black_material = new THREE.MeshBasicMaterial({map: black_texture});
                    var white_cap_material = new THREE.MeshBasicMaterial({map: white_cap_texture});
                    var black_cap_material = new THREE.MeshBasicMaterial({map: black_cap_texture});

                    for (i = 0; i < this.tottiles; i++) {
                        var stackno = Math.floor(i / 10);
                        var stackheight = i % 10;

                        var piece;

                        piece = new THREE.Mesh(geometry, white_material);
                        piece.position.set(this.position.endx + 50, stackheight * piece_height, this.position.endz - piece_size - stackno * (piece_size + 15));
                        piece.iswhitepiece = true;
                        piece.isstanding = false;
                        piece.onsquare = null;
                        piece.isboard = false;
                        piece.iscapstone = false;

                        this.piece_objects.push(piece);
                        scene.add(piece);

                        piece = new THREE.Mesh(geometry, black_material);
                        piece.position.set(this.position.x - 50 - piece_size, stackheight * piece_height, this.position.z + stackno * (piece_size + 15));
                        piece.iswhitepiece = false;
                        piece.isstanding = false;
                        piece.onsquare = null;
                        piece.isboard = false;
                        piece.iscapstone = false;

                        this.piece_objects.push(piece);
                        scene.add(piece);
                    }
                    for (i = 0; i < this.totcaps; i++) {
                        var stackno = Math.floor(this.tottiles / 10) + i;
                        var geometry = new THREE.CylinderGeometry(capstone_radius,
                                capstone_radius, capstone_height, 30);
                        geometry.center();
                        var piece = new THREE.Mesh(geometry, white_cap_material);
                        piece.position.set(this.position.endx + 50, capstone_height / 2, this.position.endz - piece_size - stackno * (piece_size + 15));
                        piece.iswhitepiece = true;
                        piece.isstanding = true;
                        piece.onsquare = null;
                        piece.isboard = false;
                        piece.iscapstone = true;

                        this.piece_objects.push(piece);
                        scene.add(piece);

                        piece = new THREE.Mesh(geometry, black_cap_material);
                        piece.position.set(this.position.x - 50 - piece_size, capstone_height / 2, this.position.z + stackno * (piece_size + 15));
                        piece.iswhitepiece = false;
                        piece.isstanding = true;
                        piece.onsquare = null;
                        piece.isboard = false;
                        piece.iscapstone = true;

                        this.piece_objects.push(piece);
                        scene.add(piece);
                    }
                },
                file: function (no) {
                    return String.fromCharCode('A'.charCodeAt(0) + no);
                },
                //file is no. rank is no.
                squarename: function (file, rank) {
                    return this.file(file) + (rank + 1);
                },
                get_board_obj: function (file, rank) {
                    return this.sq[file][this.size - 1 - rank].board_object;
                },
                incmovecnt: function () {
                    this.movecount++;
                    document.getElementById("move-sound").play();

                    $('#player-me').toggleClass('selectplayer');
                    $('#player-opp').toggleClass('selectplayer');
                    /*v1 = document.getElementById("player-opp");
                    v1.className = (v1.className === "") ? "selectplayer" : "";
                    v2 = document.getElementById("player-me");
                    v2.className = (v2.className === "") ? "selectplayer" : "";*/

                    if (this.scratch) {
                        if (this.mycolor === "white")
                            this.mycolor = "black";
                        else
                            this.mycolor = "white";
                    }

                    this.ismymove = this.checkifmymove();
                },
                leftclick: function () {
                    this.remove_total_highlight();
                    if (!this.ismymove) {
                        return;
                    }

                    if (this.highlighted && this.selected) {
                        st = this.get_stack(this.highlighted);
                        hlt = this.highlighted;
                        this.unhighlight_sq();
                        sel = this.selected;
                        this.unselect();

                        //place on board
                        if (st.length === 0) {
                            this.push(hlt, sel);

                            var stone = 'Piece';
                            if (sel.iscapstone)
                                stone = 'Cap';
                            else if (sel.isstanding)
                                stone = 'Wall';

                            console.log("Place " + this.movecount,
                                    sel.iswhitepiece ? 'White' : 'Black', stone,
                                    this.squarename(hlt.file, hlt.rank));

                            var sqname = this.squarename(hlt.file, hlt.rank);
                            var msg = "P " + sqname;
                            if (stone !== 'Piece')
                                msg += " " + stone.charAt(0);
                            this.sendmove(msg);
                            this.notatePmove(sqname, stone.charAt(0));

                            var pcs;
                            if (this.mycolor === "white") {
                                this.whitepiecesleft--;
                                pcs = this.whitepiecesleft;
                            } else {
                                this.blackpiecesleft--;
                                pcs = this.blackpiecesleft;
                            }
                            if (this.scratch) {
                                var over = this.checkroadwin();
                                if(!over) {
                                  over = this.checksquaresover();
                                  if (!over && pcs <= 0) {
                                      this.findwhowon();
                                      this.gameover();
                                      return;
                                  }
                                }
                            }
                            this.incmovecnt();
                        }
                        return;
                    }

                    //if already selected
                    if (this.selected) {
                        raycaster.setFromCamera(mouse, camera);
                        var intersects = raycaster.intersectObjects(scene.children);
                        if (intersects.length > 0) {
                            var obj = intersects[0].object;
                            //if already selected is same as clicked obj, rotate it
                            if (this.selected === obj && Math.floor(this.movecount / 2) !== 0) {
                                this.rotate(obj);
                                return;
                            }
                        }
                        this.unselect(obj);
                        return;
                    }
                    if (this.selectedStack) {
                        //move
                        if (this.highlighted && this.selectedStack.length > 0) {
                            var obj = this.selectedStack.pop();
                            //this.unselectStackElem(obj);
                            this.push(this.highlighted, obj);
                            this.move_stack_over(this.highlighted, this.selectedStack);
                            this.move.squares.push(this.highlighted);

                            if (this.move.squares.length > 1 && this.move.dir === 'U')
                                this.setmovedir();

                            if (this.selectedStack.length === 0) {
                                this.move.end = this.highlighted;
                                this.selectedStack = null;
                                this.unhighlight_sq();
                                this.generateMove();
                            }
                        } else {
                            this.move.end = this.move.squares[this.move.squares.length - 1];
                            this.unselectStack();
                            this.generateMove();
                        }
                        return;
                    }

                    this.unhighlight_sq();

                    raycaster.setFromCamera(mouse, camera);
                    var intersects = raycaster.intersectObjects(scene.children);
                    //select piece
                    if (intersects.length > 0) {
                        var obj = intersects[0].object;

                        if (!obj.isboard && !obj.onsquare) {
                            if (obj.iswhitepiece !== this.is_white_piece_to_move())
                                return;
                            //no capstone move on 1st moves
                            if (Math.floor(this.movecount / 2) === 0 && obj.iscapstone)
                                return;

                            this.select(obj);
                        }
                        //select stack ... no stack selection on 1st moves
                        else if (!this.selectedStack && Math.floor(this.movecount / 2) !== 0) {
                            var sq = obj;
                            if (!obj.isboard) {
                                if (!obj.onsquare)
                                    return;
                                sq = obj.onsquare;
                            }
                            var stk = this.get_stack(sq);
                            if (this.is_top_mine(sq) && stk.length > 0) {
                                this.selectStack(stk);
                                this.move.start = sq;
                                this.move.squares.push(sq);
                            }
                        }
                    }
                },
                mousemove: function () {
                    if (!this.ismymove)
                        return;

                    raycaster.setFromCamera(mouse, camera);
                    if (!this.selected && !this.selectedStack)
                        return;

                    var intersects = raycaster.intersectObjects(scene.children);

                    if (intersects.length > 0) {
                        var obj = intersects[0].object;
                        if (!obj.isboard && !obj.onsquare)
                            return;
                        if (!obj.isboard)
                            obj = obj.onsquare;

                        if (this.selectedStack) {
                            var tp = this.top_of_stack(obj);
                            if (tp && tp.iscapstone)
                                return;
                            if (tp && tp.isstanding &&
                                    !this.selectedStack[this.selectedStack.length - 1].iscapstone)
                                return;

                            var prev = this.move.squares[this.move.squares.length - 1];

                            var rel = this.sqrel(prev, obj);

                            if (this.move.dir === 'U' && rel !== 'OUTSIDE')
                                this.highlight_sq(obj);
                            else if (this.move.dir === rel || rel === 'O')
                                this.highlight_sq(obj);
                        } else if (this.get_stack(obj).length === 0) {
                            this.highlight_sq(obj);
                        }
                    } else {
                        this.unhighlight_sq();
                    }
                },
                sendmove: function (e) {
                    if (!this.server || this.scratch)
                        return;
                    server.send("Game#" + this.gameno + " " + e);
                },
                getfromstack: function (cap, iswhite) {
                    //randomly get any piece
                    for (i = this.piece_objects.length-1; i >= 0; i--) {
                        var obj = this.piece_objects[i];
                        if (!obj.onsquare && (obj.iswhitepiece === iswhite)) {
                            if (cap === obj.iscapstone) {
                              return obj;
                            }
                        }
                    }
                    return null;
                },
                //move the server sends
                serverPmove: function (file, rank, caporwall) {
                    var obj = this.getfromstack((caporwall === 'C'), this.is_white_piece_to_move());

                    if (!obj) {
                        console.log("something is wrong");
                        return;
                    }

                    if (caporwall === 'W') {
                        this.standup(obj);
                    }

                    var hlt = this.get_board_obj(file.charCodeAt(0) - 'A'.charCodeAt(0), rank - 1);
                    this.push(hlt, obj);

                    this.notatePmove(file + rank, caporwall);
                    this.incmovecnt();
                },
                //Move move the server sends
                serverMmove: function (f1, r1, f2, r2, nums) {
                    var s1 = this.get_board_obj(f1.charCodeAt(0) - 'A'.charCodeAt(0), r1 - 1);
                    var fi = 0, ri = 0;
                    if (f1 === f2)
                        ri = r2 > r1 ? 1 : -1;
                    if (r1 === r2)
                        fi = f2 > f1 ? 1 : -1;

                    var tot = 0;
                    for (i = 0; i < nums.length; i++)
                        tot += nums[i];

                    var tstk = [];
                    var stk = this.get_stack(s1);
                    for (i = 0; i < tot; i++) {
                        tstk.push(stk.pop());
                    }
                    for (i = 0; i < nums.length; i++) {
                        var sq = this.get_board_obj(s1.file + (i + 1) * fi, s1.rank + (i + 1) * ri);
                        for (j = 0; j < nums[i]; j++) {
                            this.push(sq, tstk.pop());
                        }
                    }
                    this.notateMmove(f1.charCodeAt(0) - 'A'.charCodeAt(0), Number(r1) - 1,
                            f2.charCodeAt(0) - 'A'.charCodeAt(0), Number(r2) - 1, nums);
                    this.incmovecnt();
                },
                gameover: function () {
                    console.log('gameover ' + this.result);
                    this.notate(this.result);
                    alert("info", "Game over!! " + this.result);
                    this.scratch = true;
                },
                newgame: function (sz, col) {
                    this.clear();
                    this.init(sz, col, false, false);
                },
                findwhowon: function () {
                    var whitec = 0, blackc = 0;
                    for (i = 0; i < this.size; i++) {
                        for (j = 0; j < this.size; j++) {
                            var stk = this.sq[i][j];
                            if (stk.length === 0)
                                continue;
                            var top = stk[stk.length - 1];
                            if (top.isstanding && !top.iscapstone)
                                continue;
                            if (top.iswhitepiece)
                                whitec++;
                            else
                                blackc++;
                        }
                    }
                    if (whitec === blackc)
                        this.result = "1/2-1/2";
                    else if (whitec > blackc)
                        this.result = "F-0";
                    else
                        this.result = "0-F";
                },
                checkroadwin: function () {
                    for (var i = 0; i < this.size; i++) {
                        for (var j = 0; j < this.size; j++) {
                            var cur_st = this.sq[i][j];
                            cur_st.graph = -1;
                            if (cur_st.length === 0)
                                continue;

                            var ctop = cur_st[cur_st.length - 1];
                            if (ctop.isstanding && !ctop.iscapstone)
                                continue;

                            cur_st.graph = (i + j * this.size).toString();

                            if (i - 1 >= 0) {
                                var left_st = this.sq[i - 1][j];
                                if (left_st.length !== 0) {
                                    var ltop = left_st[left_st.length - 1];
                                    if (!(ltop.isstanding && !ltop.iscapstone)) {
                                        if (ctop.iswhitepiece === ltop.iswhitepiece) {
                                            for (var r = 0; r < this.size; r++) {
                                                for (var c = 0; c < this.size; c++) {
                                                    if (this.sq[r][c].graph === cur_st.graph) {
                                                        this.sq[r][c].graph = left_st.graph;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            if (j - 1 >= 0) {
                                var top_st = this.sq[i][j - 1];
                                if (top_st.length !== 0) {
                                    var ttop = top_st[top_st.length - 1];
                                    if (!(ttop.isstanding && !ttop.iscapstone)) {
                                        if (ctop.iswhitepiece === ttop.iswhitepiece) {
                                            for (var r = 0; r < this.size; r++) {
                                                for (var c = 0; c < this.size; c++) {
                                                    if (this.sq[r][c].graph === cur_st.graph) {
                                                        this.sq[r][c].graph = top_st.graph;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    var whitewin = false;
                    var blackwin = false;
                    //            console.log("--------");
                    //            for(var i=0;i<this.size;i++){
                    //                var st="";
                    //                for(var j=0;j<this.size;j++){
                    //                    st+="("+this.sq[i][j].graph+") ";
                    //                }
                    //                console.log(st);
                    //            }
                    //            console.log("=======");
                    for (var tr = 0; tr < this.size; tr++) {
                        var tsq = this.sq[tr][0];
                        var no = tsq.graph;
                        if (no === -1)
                            continue;
                        for (var br = 0; br < this.size; br++) {
                            var brno = this.sq[br][this.size - 1].graph;
                            if (no === brno) {
                                if (tsq[tsq.length - 1].iswhitepiece)
                                    whitewin = true;
                                else
                                    blackwin = true;
                            }
                        }
                    }
                    for (var tr = 0; tr < this.size; tr++) {
                        var tsq = this.sq[0][tr];
                        var no = tsq.graph;
                        if (no === -1)
                            continue;
                        for (var br = 0; br < this.size; br++) {
                            var brno = this.sq[this.size - 1][br].graph;
                            if (no === brno) {
                                if (tsq[tsq.length - 1].iswhitepiece)
                                    whitewin = true;
                                else
                                    blackwin = true;
                            }
                        }
                    }
                    if (whitewin && blackwin)
                        this.result = "1/2-1/2";
                    else if (whitewin)
                        this.result = "R-0";
                    else if (blackwin)
                        this.result = "0-R";

                    if (whitewin || blackwin) {
                      this.gameover();
                      return true;
                    }
                    return false;
                },
                checksquaresover: function () {
                    for (i = 0; i < this.size; i++)
                        for (j = 0; j < this.size; j++)
                            if (this.sq[i][j].length === 0)
                                return false;

                    this.findwhowon();
                    this.gameover();
                    return true;
                },
                reverseboard: function () {
                    camera.position.z = -camera.position.z;
                    this.boardside = (this.boardside === "white") ? "black" : "white";
                },
                setmovedir: function () {
                    var s1 = this.move.start;
                    var s2 = this.move.squares[1];
                    if (s1.file === s2.file && s1.rank === s2.rank)
                        return;

                    if (s1.file === s2.file) {
                        if (s2.rank > s1.rank)
                            this.move.dir = 'N';
                        else
                            this.move.dir = 'S';
                    } else {
                        if (s2.file > s1.file)
                            this.move.dir = 'E';
                        else
                            this.move.dir = 'W';
                    }
                },
                notate: function (txt) {
                    if (this.movecount !== 0 && this.movecount % 2 === 1) {
                        var om = document.getElementById("moveslist");
                        var col = om.rows[om.rows.length - 1].cells[2];
                        col.innerHTML = txt;
                    } else {
                        var ol = document.getElementById("moveslist");
                        var row = ol.insertRow();
                        var cell0 = row.insertCell(0);
                        cell0.innerHTML = Math.floor(this.movecount / 2 + 1) + '.';
                        var cell1 = row.insertCell(1);
                        row.insertCell(2);
                        cell1.innerHTML = txt;
                    }
                    $('#notationbar').scrollTop($('#moveslist tr:last').position().top);
                },
                notatePmove: function (sqname, pos) {
                    if (pos === 'W')
                        pos = 'S';
                    else if (pos === 'C')
                        pos = 'C';
                    else
                        pos = '';
                    this.notate(pos + sqname.toLowerCase());
                },
                //all params are nums
                notateMmove: function (stf, str, endf, endr, nos) {
                    var dir = '';
                    if (stf === endf)
                        dir = (endr < str) ? '-' : '+';
                    else
                        dir = (endf < stf) ? '<' : '>';
                    var tot = 0;
                    var lst = '';
                    for (var i = 0; i < nos.length; i++) {
                        tot += Number(nos[i]);
                        lst = lst + (nos[i] + '').trim();
                    }
                    if (tot === 1) {
                        var s1 = this.get_board_obj(stf, str);
                        if (this.get_stack(s1).length === 0) {
                            tot = '';
                            lst = '';
                        } else if (tot === Number(lst))
                            lst = '';
                    } else if (tot === Number(lst))
                        lst = '';
                    var move = tot + this.squarename(stf, str).toLowerCase()
                            + dir + '' + lst;
                    this.notate(move);
                },
                generateMove: function () {
                    var st = this.squarename(this.move.start.file, this.move.start.rank);
                    var end = this.squarename(this.move.end.file, this.move.end.rank);
                    var lst = [];
                    var prev = null;

                    for (i = 0, c = 0; i < this.move.squares.length; i++) {
                        var obj = this.move.squares[i];
                        if (obj === this.move.start)
                            continue;

                        if (obj === prev)
                            lst[c - 1] = lst[c - 1] + 1;
                        else {
                            prev = obj;
                            lst[c] = 1;
                            c++;
                        }
                    }
                    if (st !== end) {
                        console.log("Move ", this.movecount, st, end, lst);
                        var nos = "";
                        for (i = 0; i < lst.length; i++)
                            nos += lst[i] + " ";
                        this.sendmove("M " + st + " " + end + " " + nos.trim());
                        this.notateMmove(this.move.start.file, this.move.start.rank,
                                this.move.end.file, this.move.end.rank, nos);
                        if (this.scratch) {
                            this.checkroadwin();
                            this.checksquaresover();
                        }
                        this.incmovecnt();
                    }
                    this.move = {start: null, end: null, dir: 'U', squares: []};
                },
                push: function (sq, pc) {
                    var st = this.get_stack(sq);
                    var top = this.top_of_stack(sq);
                    if (top && top.isstanding && !top.iscapstone && pc.iscapstone)
                        this.rotate(top);

                    pc.position.x = sq.position.x;

                    if (pc.isstanding) {
                      if(pc.iscapstone)
                        pc.position.y = sq_height/2 + capstone_height/2 + piece_height*st.length;
                      else
                        pc.position.y = sq_height/2 + piece_size/2 + piece_height * st.length;
                    } else
                        pc.position.y = sq_height + st.length * piece_height;

                    pc.position.z = sq.position.z;
                    pc.onsquare = sq;
                    st.push(pc);
                },
                rotate: function (piece) {
                    if (piece.iscapstone)
                        return;
                    if (piece.isstanding)
                        this.flatten(piece);
                    else
                        this.standup(piece);
                },
                flatten: function (piece) {
                    if (!piece.isstanding)
                        return;
                    piece.position.y -= piece_size / 2 - piece_height / 2;
                    piece.rotateX(Math.PI / 2);
                    piece.isstanding = false;
                },
                standup: function (piece) {
                    if (piece.isstanding)
                        return;
                    piece.position.y += piece_size / 2 - piece_height / 2;
                    piece.rotateX(-Math.PI / 2);
                    piece.isstanding = true;
                },
                rightclick: function () {
                    if (this.selected && Math.floor(this.movecount / 2) !== 0) {
                        this.rotate(this.selected);
                    } else {
                        raycaster.setFromCamera(mouse, camera);
                        var intersects = raycaster.intersectObjects(scene.children);
                        if (intersects.length > 0) {
                            var obj = intersects[0].object;
                            var sq = obj;
                            if (!obj.isboard)
                                sq = obj.onsquare;
                            var stk = this.get_stack(sq);
                            if (stk.length === 0)
                                return;
                            for (var i = 0; i < scene.children.length; i++) {
                                var obj = scene.children[i];
                                if (obj.isboard || !obj.onsquare)
                                    continue;
                                obj.visible = false;
                            }
                            for (var i = 0; i < stk.length; i++) {
                                stk[i].visible = true;
                            }
                            this.totalhighlighted = sq;
                        }
                    }
                },
                remove_total_highlight: function () {
                    if (this.totalhighlighted !== null) {
                        for (var i = 0; i < scene.children.length; i++) {
                            var obj = scene.children[i];
                            if (obj.isboard || !obj.onsquare)
                                continue;
                            obj.visible = true;
                        }
                        this.totalhighlighted = null;
                    }
                },
                rightup: function () {
                    console.log('right up');
                    this.remove_total_highlight();
                },
                clear: function () {
                    for (var i = scene.children.length - 1; i >= 0; i--) {
                        scene.remove(scene.children[i]);
                    }
                    var tbl = document.getElementById("moveslist");
                    while (tbl.rows.length > 0)
                        tbl.deleteRow(0);
                    document.getElementById("draw").src = "images/offer-hand.png";
                    stopTime();

                    $('#player-me-name').removeClass('player1-name');
                    $('#player-me-name').removeClass('player2-name');
                    $('#player-opp-name').removeClass('player1-name');
                    $('#player-opp-name').removeClass('player2-name');

                    $('#player-me-time').removeClass('player1-time');
                    $('#player-me-time').removeClass('player2-time');
                    $('#player-opp-time').removeClass('player1-time');
                    $('#player-opp-time').removeClass('player2-time');

                    $('#player-me').removeClass('selectplayer');
                    $('#player-opp').removeClass('selectplayer');

                    //i'm always black after clearing
                    $('#player-me-name').addClass('player2-name');
                    $('#player-opp-name').addClass('player1-name');

                    $('#player-me-time').addClass('player2-time');
                    $('#player-opp-time').addClass('player1-time');

                    $('#player-me-img').attr('src', 'images/player-black.png');
                    $('#player-opp-img').attr('src', 'images/player-white.png');

                    $('#player-opp').addClass('selectplayer');

                    $('.player1-name:first').html('You');
                    $('.player2-name:first').html('You');
                    $('.player1-time:first').html('0:00');
                    $('.player2-time:first').html('0:00');

                    $('#gameoveralert').modal('hide');
                },
                sqrel: function (sq1, sq2) {
                    var f1 = sq1.file;
                    var r1 = sq1.rank;
                    var f2 = sq2.file;
                    var r2 = sq2.rank;
                    if (f1 === f2 && r1 === r2)
                        return 'O';

                    if (f1 === f2) {
                        if (r2 === r1 + 1)
                            return 'N';
                        else if (r1 === r2 + 1)
                            return 'S';
                    } else if (r1 === r2) {
                        if (f2 === f1 + 1)
                            return 'E';
                        else if (f1 === f2 + 1)
                            return 'W';
                    }
                    return 'OUTSIDE';
                },
                checkifmymove: function () {
                    if (this.observing)
                        return false;
                    var tomove = (this.movecount % 2 === 0) ? "white" : "black";
                    //console.log('tomove = ', tomove, this.mycolor, tomove===this.mycolor);
                    return tomove === this.mycolor;
                },
                is_white_piece_to_move: function () {
                    if (this.movecount === 0)
                        return false;
                    if (this.movecount === 1)
                        return true;
                    return this.movecount % 2 === 0;
                },
                select: function (obj) {
                    obj.position.y += stack_selection_height;
                    this.selected = obj;
                },
                unselect: function () {
                    if (this.selected) {
                        this.selected.position.y -= stack_selection_height;
                        this.selected = null;
                    }
                },
                selectStack: function (stk) {
                    //this.selectedStack = stk;
                    this.selectedStack = [];
                    for (i = 0; stk.length > 0 && i < this.size; i++) {
                        obj = stk.pop();
                        obj.position.y += stack_selection_height;
                        this.selectedStack.push(obj);
                    }
                },
                unselectStackElem: function (obj) {
                    obj.position.y -= stack_selection_height;
                },
                unselectStack: function () {
                    var stk = this.selectedStack.reverse();
                    var lastsq = this.move.squares[this.move.squares.length - 1];
                    //push unselected stack elems onto last moved square
                    for (i = 0; i < stk.length; i++) {
                        this.unselectStackElem(stk[i]);
                        this.push(lastsq, stk[i]);
                        this.move.squares.push(lastsq);
                    }
                    this.selectedStack = null;
                },
                highlight_sq: function (sq) {
                    this.unhighlight_sq(this.highlighted);
                    this.highlighted = sq;

                    highlighter.position.x = sq.position.x;
                    highlighter.position.y = sq_height / 2;
                    highlighter.position.z = sq.position.z;
                    scene.add(highlighter);
                },
                unhighlight_sq: function () {
                    if (this.highlighted) {
                        //this.highlighted.position.y -= 10;
                        this.highlighted = null;
                        scene.remove(highlighter);
                    }
                },
                get_stack: function (sq) {
                    return this.sq[sq.file][sq.rank];
                },
                top_of_stack: function (sq) {
                    var st = this.get_stack(sq);
                    if (st.length === 0)
                        return null;
                    return st[st.length - 1];
                },
                is_top_mine: function (sq) {
                    var ts = this.top_of_stack(sq);
                    if (!ts)
                        return true;
                    if (ts.iswhitepiece && this.mycolor === "white")
                        return true;
                    if (!ts.iswhitepiece && this.mycolor !== "white")
                        return true;
                    return false;
                },
                move_stack_over: function (sq, stk) {
                    if (stk.length === 0)
                        return;
                    var top = this.top_of_stack(sq);
                    if (!top)
                        top = sq;

                    var ts = stk[stk.length - 1];
                    if (ts.onsquare === sq)
                        return;

                    var diffy = ts.position.y - top.position.y;

                    for (i = 0; i < stk.length; i++) {
                        stk[i].position.x = sq.position.x;
                        stk[i].position.z = sq.position.z;
                        stk[i].position.y += stack_selection_height - diffy;
                        stk[i].onsquare = sq;
                    }
                },
                loadtpn: function (tpn) {
                    if (!this.scratch) {
                        alert('warning', 'TPN won\'t be displayed in the middle of an online game');
                        return;
                    }
                    tpn = tpn.trim().split("[")[1].split("]")[0].trim();
                    var tt = tpn.split(" ");
                    var ptomove = tt[1];//string

                    var rows = tt[0].split("/");
                    this.clear();
                    this.init(rows.length, "white", true);
                    for (var i = 0; i < rows.length; i++) {
                        var cells = rows[i].split(",");
                        var cols = 0;
                        for (var j = 0; j < cells.length; j++, cols++) {
                            var cell = cells[j];
                            if (cell.charAt(0) === 'x') {
                                if (cell.length === 1) //lone x
                                    continue;
                                cols += Number(cell.charAt(1)) - 1;//x5
                                continue;
                            }
                            var sq = this.get_board_obj(cols, rows.length - 1 - i);

                            for (var k = 0; k < cell.length; k++) {
                                var ch = cell[k];
                                //console.log('ch', ch);
                                if (ch === 'S' || ch === 'C')
                                    continue;
                                var piece = '';
                                if (k + 1 === cell.length - 1) {
                                    if (cell[k + 1] === 'C')
                                        piece = 'C';
                                    else if (cell[k + 1] === 'S')
                                        piece = 'W';
                                }

                                var pc = this.getfromstack(piece === 'C', ch === '1');
                                if (pc === null || typeof pc === 'undefined') {
                                    alert('danger', 'Out of pieces. Wrong TPS!');
                                    return;
                                }
                                if (piece === 'W') {
                                    this.standup(pc);
                                }
                                this.push(sq, pc);
                            }
                        }
                    }
                }
            };

            var server = {
                connection: null,
                timeoutvar: null,
                myname: null,
                tries:0,
                timervar: null,
                lastTimeUpdate: null,

                init: function () {
                    console.log("called init");
                    if (this.connection && this.connection.readyState === 2)//closing connection
                        return;
                    if (this.connection && this.connection.readyState === 3)//closed
                        this.connection = null;
                    if (this.connection) { //user clicked logout
                        this.connection.close();
                        alert("info", "Disconnnecting from server....");

                        localStorage.removeItem('keeploggedin');
                        localStorage.removeItem('usr');
                        localStorage.removeItem('token');
                        return;
                    }
                    var url = window.location.host;
                    if (url.indexOf("playtak") > -1)
                        url = 'playtak.com:3000';
                    var proto='ws://';
                    if (window.location.protocol === "https:")
                        proto='wss://';
                    this.connection = new WebSocket(proto+url, "binary");
                    board.server = this;
                    this.connection.onerror = function (e) {
                        this.output("Connection error: " + e);
                    };
                    this.connection.onmessage = function (e) {
                        var blob = e.data;
                        var reader = new FileReader();
                        reader.onload = function (event) {
                            var res = reader.result.split("\n");
                            var i;
                            for (i = 0; i < res.length - 1; i++) {
                                server.msg(res[i]);
                            }
                        };
                        reader.readAsText(blob);
                    };
                    this.connection.onopen = function (e) {
                    };
                    this.connection.onclose = function (e) {
                        document.getElementById('login-button').textContent = 'Sign up / Login';
                        document.getElementById("onlineplayers").innerHTML = "0";
                        document.getElementById("seekcount").innerHTML = "0";
                        document.getElementById("gamecount").innerHTML = "0";
                        document.getElementById("scratchsize").disabled = false;
                        board.scratch = true;
                        board.observing = false;
                        board.gameno = 0;
                        document.title = "Tak";
                        $('#seeklist').children().each(function() {
                            this.remove();
                        });
                        $('#gamelist').children().each(function() {
                            this.remove();
                        });
                        stopTime();
                        alert("info", "You're disconnected from server");
                    };
                },
                login: function () {
                    var name = $('#login-username').val();
                    var pass = $('#login-pwd').val();

                    this.send("Login " + name + " " + pass);
                },
                guestlogin: function() {
                    this.send("Login Guest");
                },
                register: function () {
                    var name = $('#register-username').val();
                    var email = $('#register-email').val();
                    this.send("Register " + name + " " + email);
                },
                keepalive: function() {
                    if(server.connection && server.connection.readyState === 1)//open connection
                        server.send("PING");
                },
                msg: function (e) {
                    output(e);
                    e = e.trim();
                    if (e.startsWith("Game Start")) {
                        //Game Start no. size player_white vs player_black yourcolor time
                        var spl = e.split(" ");
                        board.newgame(Number(spl[3]), spl[7]);
                        board.gameno = Number(spl[2]);
                        console.log("gno "+board.gameno);
                        document.getElementById("scratchsize").disabled = true;

                        $('#player-me-name').removeClass('player1-name');
                        $('#player-me-name').removeClass('player2-name');
                        $('#player-opp-name').removeClass('player1-name');
                        $('#player-opp-name').removeClass('player2-name');

                        $('#player-me-time').removeClass('player1-time');
                        $('#player-me-time').removeClass('player2-time');
                        $('#player-opp-time').removeClass('player1-time');
                        $('#player-opp-time').removeClass('player2-time');

                        $('#player-me').removeClass('selectplayer');
                        $('#player-opp').removeClass('selectplayer');

                        if (spl[7] === "white") {//I am white
                            $('#player-me-name').addClass('player1-name');
                            $('#player-opp-name').addClass('player2-name');

                            $('#player-me-time').addClass('player1-time');
                            $('#player-opp-time').addClass('player2-time');

                            $('#player-me-img').attr('src', 'images/player-white.png');
                            $('#player-opp-img').attr('src', 'images/player-black.png');

                            $('#player-me').addClass('selectplayer');
                        } else {//I am black
                            $('#player-me-name').addClass('player2-name');
                            $('#player-opp-name').addClass('player1-name');

                            $('#player-me-time').addClass('player2-time');
                            $('#player-opp-time').addClass('player1-time');

                            $('#player-me-img').attr('src', 'images/player-black.png');
                            $('#player-opp-img').attr('src', 'images/player-white.png');

                            $('#player-opp').addClass('selectplayer');
                        }

                        $('.player1-name:first').html(spl[4]);
                        $('.player2-name:first').html(spl[6]);
                        document.title = "Tak: " + spl[4] + " vs " + spl[6];

                        var time = Number(spl[8]);
                        var m = parseInt(time/60);
                        var s = getZero(parseInt(time%60));
                        $('.player1-time:first').html(m+':'+s);
                        $('.player2-time:first').html(m+':'+s);

                        var chimesound = document.getElementById("chime-sound");
                        chimesound.play();
                    }
                    else if (e.startsWith("Observe Game#")) {
                        //Observe Game#1 player1 vs player2, 4x4, 180, 7 half-moves played, player2 to move
                        var spl = e.split(" ");
                        board.clear();
                        board.init(Number(spl[5].split("x")[0]), "white", false, true);
                        board.gameno = Number(spl[1].split("Game#")[1]);
                        $('.player1-name:first').html(spl[2]);
                        $('.player2-name:first').html(spl[4].split(",")[0]);
                        document.title = "Tak: " + spl[2] + " vs " + spl[4];

                        var time = Number(spl[6].split(",")[0]);
                        var m = parseInt(time/60);
                        var s = getZero(parseInt(time%60));
                        $('.player1-time:first').html(m+':'+s);
                        $('.player2-time:first').html(m+':'+s);
                    }
                    else if (e.startsWith("GameList Add Game#")) {
                        //GameList Add Game#1 player1 vs player2, 4x4, 180, 0 half-moves played, player1 to move
                        var spl = e.split(" ");
                        var t = Number(spl[7].split(",")[0]);
                        var m = parseInt(t/60);
                        var s = getZero(parseInt(t%60));

                        var val = spl[3] + " vs " + spl[5].split(",")[0] + " " + spl[6].split(",")[0] + " " + m+':'+s;
                        var $li = $('<li/>').appendTo($('#gamelist'));
                        $('<a/>').text(val).
                                click(function() {server.observegame(spl[2].split("Game#")[1]);}).
                                    appendTo($li);

                        var op = document.getElementById("gamecount");
                        op.innerHTML = Number(op.innerHTML)+1;
                    }
                    else if (e.startsWith("GameList Remove Game#")) {
                        //GameList Remove Game#1 player1 vs player2, 4x4, 180, 0 half-moves played, player1 to move
                        var spl = e.split(" ");
                        var t = Number(spl[7].split(",")[0]);
                        var m = parseInt(t/60);
                        var s = getZero(parseInt(t%60));

                        var val = spl[3] + " vs " + spl[5].split(",")[0] + " " + spl[6].split(",")[0] + " " + m+':'+s;
                        $('#gamelist').children().each(function() {
                            if($(this).find('a')[0].innerHTML === val) {
                                this.remove();
                            }
                        });

                        var op = document.getElementById("gamecount");
                        op.innerHTML = Number(op.innerHTML)-1;
                    }
                    else if (e.startsWith("Game#")) {
                      var gameno = Number(e.split("Game#")[1].split(" ")[0]);
                      console.log("game no "+gameno+" "+board.gameno);
                      //Game#1 ...
                      if(gameno === board.gameno) {
                        //Game#1 P A4 (C|W)
                        if (e.indexOf(" P ") > -1) {
                            var spl = e.split(" ");
                            board.serverPmove(spl[2].charAt(0), Number(spl[2].charAt(1)), spl[3]);
                        }
                        //Game#1 M A2 A5 2 1
                        else if (e.indexOf(" M ") > -1) {
                            var spl = e.split(" ");
                            var nums = [];
                            for (i = 4; i < spl.length; i++)
                                nums.push(Number(spl[i]));
                            board.serverMmove(spl[2].charAt(0), Number(spl[2].charAt(1)),
                                    spl[3].charAt(0), Number(spl[3].charAt(1)),
                                    nums);
                        }
                        //Game#1 Time 170 200
                        else if (e.indexOf(" Time ") > -1) {
                          var spl = e.split(" ");
                          var wt = Number(spl[2]);
                          var bt = Number(spl[3]);
                          lastWt = wt;
                          lastBt = bt;

                          var now = new Date();
                          lastTimeUpdate = now.getHours()*60*60 + now.getMinutes()*60+now.getSeconds();


                          $('.player1-time:first').html(parseInt(wt/60)+':'+getZero(wt%60));
                          $('.player2-time:first').html(parseInt(bt/60)+':'+getZero(bt%60));

                          if(board.movecount > 0) {
                            startTime(true);
                          }
                        }
                        //Game#1 OfferDraw
                        else if (e.indexOf("OfferDraw") > -1) {
                            document.getElementById("draw").src = "images/hand-other-offered.png";
                            alert("info", "Draw is offered by your opponent");
                        }
                        //Game#1 RemoveDraw
                        else if (e.indexOf("RemoveDraw") > -1) {
                            document.getElementById("draw").src = "images/offer-hand.png";
                            alert("info", "Draw offer is taken back by your opponent");
                        }
                        //Game#1 Over result
                        else if (e.indexOf("Over") > -1) {
                            document.title = "Tak";
                            var spl = e.split(" ");
                            board.scratch = true;
                            board.notate(spl[2]);

                            var msg = "Game over " + spl[2];
                            alert("info", msg);
                            document.getElementById("scratchsize").disabled = false;
                            stopTime();

                            $('#gameoveralert-text').html(msg);
                            $('#gameoveralert').modal('show');
                        }
                        //Abandoned
                        else if (e.indexOf("Abandoned") > -1) {
                            //Game#1 Abandoned. name quit
                            var spl = e.split(" ");
                            document.title = "Tak";
                            board.scratch = true;

                            var msg = "Game abandoned by " + spl[2];
                            alert("info", msg);
                            document.getElementById("scratchsize").disabled = false;
                            stopTime();

                            $('#gameoveralert-text').html(msg);
                            $('#gameoveralert').modal('show');
                        }
                      }
                    }
                    else if (e.startsWith("Login or Register")) {
                        server.send("Client " + "TakWeb-16.03.16");

                        if(localStorage.getItem('keeploggedin')==='true' && this.tries<3) {
                          var uname = localStorage.getItem('usr');
                          var token = localStorage.getItem('token');
                          server.send("Login " + uname + " " + token);
                          this.tries++;
                        } else {
                          localStorage.removeItem('keeploggedin');
                          localStorage.removeItem('usr');
                          localStorage.removeItem('token');
                          $('#login').modal('show');
                        }
                    }
                    //Registered ...
                    else if (e.startsWith("Registered")) {
                      alert("success", "You're registered! Check mail for password");
                    }
                    //Name already taken
                    else if (e.startsWith("Name already taken")) {
                      alert("danger", "Name is already taken");
                    }
                    //Can't register with guest in the name
                    else if (e.startsWith("Can't register with guest in the name")) {
                      alert("danger", "Can't register with guest in the name");
                    }
                    //Unknown format for username/email
                    else if (e.startsWith("Unknown format for username/email")) {
                      alert("danger", e);
                    }
                    //Authentication failure
                    else if (e.startsWith("Authentication failure")) {
                        console.log('failure');
                        if(($('#login').data('bs.modal') || {}).isShown) {
                          alert("danger", "Authentication failure");
                        } else {
                          localStorage.removeItem('keeploggedin');
                          localStorage.removeItem('usr');
                          localStorage.removeItem('token');
                          $('#login').modal('show');
                        }
                    }
                    //You're already logged in
                    else if (e.startsWith("You're already logged in")) {
                      alert("warning", "You're already logged in from another window");
                      this.connection.close();
                    }
                    //Welcome kaka!
                    else if (e.startsWith("Welcome ")) {
                        this.tries = 0;
                        $('#login').modal('hide');
                        document.getElementById('login-button').textContent = 'Logout';
                        this.timeoutvar = window.setInterval(this.keepalive, 30000);
                        this.myname = e.split("Welcome ")[1].split("!")[0];
                        alert("success", "You're logged in "+this.myname+"!");

                        var rem = $('#keeploggedin').is(':checked');
                        if( rem === true && !this.myname.startsWith("Guest")) {
                          console.log('storing');
                          var name = $('#login-username').val();
                          var token = $('#login-pwd').val();

                          localStorage.setItem('keeploggedin', 'true');
                          localStorage.setItem('usr', name);
                          localStorage.setItem('token', token);
                        }
                    }
                    else if (e.startsWith("Message")) {
                        var msg = e.split("Message ");
                        alert("info", "Server says: " + msg[1]);
                    }
                    else if (e.startsWith("Error")) {
                        var msg = e.split("Error:")[1];
                        alert("danger", "Server says: "+msg);
                    }
                    else if (e.startsWith("Shout")) {
                        var msg = e.split("Shout ");
                        console.log("received msg "+msg[1]);
                        var $cs = $('#chat-server');
                        $cs.val($cs.val()+msg[1]+'\n');
                        $cs.scrollTop($cs[0].scrollHeight);
                    }
                    //new seek
                    else if (e.startsWith("Seek new")) {
                        //Seek new 1 chaitu 5 180
                        var spl = e.split(" ");

                        var t = Number(spl[5]);
                        var m = parseInt(t/60);
                        var s = getZero(parseInt(t%60));

                        var $li = $('<li/>').appendTo($('#seeklist'));
                        $('<a/>').text(spl[3]+' - '+spl[4]+'x'+spl[4]+' - '+m+':'+s).
                                click(function() {server.acceptseek(spl[2])}).
                                    appendTo($li);

                        var op = document.getElementById("seekcount");
                        op.innerHTML = Number(op.innerHTML)+1;
                    }
                    //remove seek
                    else if (e.startsWith("Seek remove")) {
                        //Seek remove 1 chaitu 5 15
                        var spl = e.split(" ");

                        var t = Number(spl[5]);
                        var m = parseInt(t/60);
                        var s = getZero(parseInt(t%60));

                        var val = spl[3]+' - '+spl[4]+'x'+spl[4]+' - '+m+':'+s;
                        $('#seeklist').children().each(function() {
                            if($(this).find('a')[0].innerHTML === val) {
                                this.remove();
                            }
                        });

                        var op = document.getElementById("seekcount");
                        op.innerHTML = Number(op.innerHTML)-1;
                    }
                    //Online players
                    else if (e.startsWith("Online ")) {
                        var op = document.getElementById("onlineplayers");
                        op.innerHTML = Number(e.split("Online ")[1]);
                    }
                },
                chat: function () {
                    var msg = $('#chat-me').val();
                    console.log('msg= '+msg);
                    this.send('Shout '+msg);
                    $('#chat-me').val('');
                },
                send: function (e) {
                    if (this.connection && this.connection.readyState === 1)
                        this.connection.send(e + "\n");
                    else
                        this.error("You are not logged on to the server");
                },
                error: function (e) {
                    alert("danger", e);
                },
                seek: function () {
                    var size = $('#boardsize').find(':selected').text();
                    size = parseInt(size);
                    var time = $('#timeselect').find(':selected').text();
                    this.send("Seek "+size+" "+time*60);
                    $('#creategamemodal').modal('hide');
                },
                removeseek: function() {
                    this.send("Seek 0 0");
                    $('#creategamemodal').modal('hide');
                },
                draw: function() {
                    if(board.scratch)
                      return;
                    else if(board.observing)
                      return;

                    var img = document.getElementById("draw");
                    if(img.src.match("offer-hand")) {//offer
                        img.src = "images/hand-i-offered.png";
                        this.send("Game#" + board.gameno + " OfferDraw");
                    } else if(img.src.match("hand-i-offered")) {//remove offer
                        img.src = "images/offer-hand.png";
                        this.send("Game#" + board.gameno + " RemoveDraw");
                    } else {//accept the offer
                        this.send("Game#" + board.gameno + " OfferDraw");
                    }
                },
                resign: function() {
                    if(board.scratch)
                      return;
                    else if(board.observing)
                      return;

                    this.send("Game#" + board.gameno + " Resign");
                },
                acceptseek: function (e) {
                    this.send("Accept " + e);
                },
                observegame: function (no) {
                    if (board.observing === false && board.scratch === false) //don't observe game while playing another
                        return;
                    if (no === board.gameno)
                        return;
                    else
                        this.send("Unobserve " + board.gameno);
                    this.send("Observe " + no);
                }
            };

            init();
            animate();

            function init() {
                canvas = document.getElementById("gamecanvas");
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                camera = new THREE.PerspectiveCamera(70, canvas.width / canvas.height, 1, 2000);
                camera.position.set(0, canvas.width / 2, canvas.height / 2);
                //camera.updateProjectionMatrix();

                scene = new THREE.Scene();

                renderer = new THREE.WebGLRenderer({canvas: canvas});
                renderer.setPixelRatio(window.devicePixelRatio);
                //renderer.setSize( window.innerWidth, window.innerHeight );
                //renderer.setSize( 800, 640);
                renderer.setClearColor(0xdddddd, 1);

                document.body.appendChild(renderer.domElement);

                window.addEventListener('resize', onWindowResize, false);
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.minDistance = 200;
                controls.maxDistance = 1500;
                controls.enableKeys = false;
                var ua = navigator.userAgent.toLowerCase();
                if (ua.indexOf("android") > -1 || ua.indexOf("iphone") > -1 ||
                        ua.indexOf("ipod") > -1 || ua.indexOf("ipad") > -1)
                    controls.zoomSpeed = 0.5;

                var material = new THREE.LineBasicMaterial({color: 0x0000f0});
                var geometry = new THREE.TorusGeometry(sq_size / 2 + 5, 3, 16, 100);
                //geometry.vertices.shift();
                highlighter = new THREE.Mesh(geometry, material);
                highlighter.rotateX(Math.PI / 2);

                canvas.addEventListener('mousedown', onDocumentMouseDown, false);
                canvas.addEventListener('mouseup', onDocumentMouseUp, false);
                canvas.addEventListener('mousemove', onDocumentMouseMove, false);

                board.init(5, "white", true);
            }

            function onWindowResize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                renderer.setSize(canvas.width, canvas.height);

                camera.aspect = canvas.width / canvas.height;
                camera.updateProjectionMatrix();

                $('#chat').offset({ top: $('nav').height() + 5 });
                $('#chat-toggle-button').offset({ top: $('nav').height() + 7 });
                $('#chat').height(window.innerHeight - $('nav').height() - 85);

                if(isBreakpoint('xs') || isBreakpoint('sm')) {
                    hidechat();
                    hidermenu();
                } else {
                    showchat();
                    showrmenu();
                }
            }

            function animate() {
                setTimeout(function () {
                    requestAnimationFrame(animate);
                }, 1000 / 30);

                renderer.render(scene, camera);
                controls.update();
            }

            function onDocumentMouseMove(e) {
                e.preventDefault();
                var x = e.clientX - canvas.offsetLeft;
                var y = e.clientY - canvas.offsetTop;
                mouse.x = (x / canvas.width) * 2 - 1;
                mouse.y = -(y / canvas.height) * 2 + 1;

                board.mousemove();
            }

            function onDocumentMouseDown(e) {
                e.preventDefault();

                var x = e.clientX - canvas.offsetLeft;
                var y = e.clientY - canvas.offsetTop;
                mouse.x = (x / canvas.width) * 2 - 1;
                mouse.y = -(y / canvas.height) * 2 + 1;

                if (e.button === 2)
                    board.rightclick();
                else
                    board.leftclick();
            }
            function onDocumentMouseUp(e) {
                if (e.button === 2)
                    board.rightup();
            }
            function output(e) {
                console.log("output:" + e);
            }

            function buttonclick() {
                var input = document.getElementById("input");
                var data = input.value;
                input.value = "";
                server.send(data);
            }

            function scratchbutton(size) {
                if (board.observing)
                    server.send("Unobserve " + board.gameno);
                if (board.scratch || board.observing) {
                    board.clear();
                    board.init(size, "white", true);
                }
            }
            function rmenu() {
                if($('#rmenu').hasClass('hidden'))
                    showrmenu();
                else
                    hidermenu();
            }
            function showrmenu() {
                $('#notation-toggle-text').html('<<<br>n<br>o<br>t<br>a<br>t<br>i<br>o<br>n');
                $('#rmenu').removeClass('hidden');
            }
            function hidermenu() {
                $('#rmenu').addClass('hidden');
                $('#notation-toggle-text').html('>><br>n<br>o<br>t<br>a<br>t<br>i<br>o<br>n');
            }
            function zoom(out) {
                console.log('zoom', out, controls);
                if (out)
                    controls.constraint.dollyOut(1.5);
                else
                    controls.constraint.dollyIn(1.5);
            }
            function loadtpn() {
                var tpn = window.prompt("Paste TPS here", "");
                if (!tpn)
                    return;
                board.loadtpn(tpn);
            }
            function statusclick() {
                var inp = document.getElementById('status-inp');
                console.log('input: '+inp.value);
                server.send(inp.value);
                inp.innerHTML='';
            }
            function volume_change() {
                var img = document.getElementById("volume-img");
                var movesound = document.getElementById("move-sound");
                var chimesound = document.getElementById("chime-sound");

                if(img.src.match("mute")) {
                    img.src = "images/ic_volume_up_black_24px.svg";
                    movesound.muted = false;
                    chimesound.muted = false;

                    movesound.play();
                    localStorage.setItem('sound', 'true');
                } else {
                    img.src = "images/ic_volume_mute_black_24px.svg";
                    movesound.muted = true;
                    chimesound.muted = true;

                    localStorage.setItem('sound', 'false');
                }
            }
            function togglechat() {
                if($('#chat').hasClass('hidden')) {
                    showchat()
                } else {
                    hidechat();
                }
            }
            function showchat() {
                $('#chat-toggle-button').css('right', 185);
                $('#chat-toggle-text').html('>><br>c<br>h<br>a<br>t');
                $('#chat').removeClass('hidden');
            }
            function hidechat() {
                $('#chat-toggle-button').css('right', 0);
                $('#chat-toggle-text').html('<<<br>c<br>h<br>a<br>t');
                $('#chat').addClass('hidden');
            }
            function isBreakpoint( alias ) {
                return $('.device-' + alias).is(':hidden');
            }
            function startTime(fromFn) {
              if(typeof fromFn === 'undefined' && !server.timervar)
                return;
              var now = new Date();
              var t = now.getHours()*60*60 + now.getMinutes()*60+now.getSeconds();
              var elapsed = t-lastTimeUpdate;

              if(board.movecount%2 === 0) {
                t1 = lastWt - elapsed;
                $('.player1-time:first').html(parseInt(t1/60)+':'+getZero(t1%60));
              } else {
                t2 = lastBt - elapsed;
                $('.player2-time:first').html(parseInt(t2/60)+':'+getZero(t2%60));
              }

              server.timervar = setTimeout(startTime, 500);
            }

            function stopTime() {
              clearTimeout(server.timervar);
              server.timervar = null;
            }

            function getZero(t) {
              return t<10?'0'+t:t;
            }

            $(document).ready(function() {
                if(localStorage.getItem('sound')==='flase') {
                    volume_change();
                }
                if(localStorage.getItem('keeploggedin')==='true') {
                    server.init();
                }
                if(isBreakpoint('xs') || isBreakpoint('sm')) {
                    hidechat();
                    hidermenu();
                } else {
                    showchat();
                    showrmenu();
                }

                $('#chat').offset({ top: $('nav').height() + 5 });
                $('#chat-toggle-button').offset({ top: $('nav').height() + 7 });
                $('#chat').height(window.innerHeight - $('nav').height() - 85);

                tour(false);
            })
        </script>

    </body>
</html>

